AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  CAMMI - Serverless Application orchestrator
  Python 3.13 runtime, 15-minute Lambda timeout, feature-based structure.

Globals:
  Function:
    Runtime: python3.13
    Timeout: 900
    MemorySize: 128
    Architectures:
      - x86_64
    Tracing: Active

Resources:
  # Nested DynamoDB stack
  DynamoDBStack:
    Type: AWS::Serverless::Application
    Properties:
      Location: db/template.yaml

  # Nested Google Libraries Layer stack
  GoogleLibrariesLayerStack:
    Type: AWS::Serverless::Application
    Properties:
      Location: layers/template.yaml

  S3Stack:
    Type: AWS::Serverless::Application
    Properties:
      Location: s3/template.yaml

  # Feedback Lambdas
  FeedbackFeature:
    Type: AWS::Serverless::Application
    DependsOn:
      - DynamoDBStack
    Properties:
      Location: feedback/template.yaml
  
  # auth lambdas
  AuthFeature:
    Type: AWS::Serverless::Application
    DependsOn:
      - DynamoDBStack
      - GoogleLibrariesLayerStack
    Properties:
      Location: auth/template.yaml
  
  OnboardingFeature:
    Type: AWS::Serverless::Application
    DependsOn:
      - DynamoDBStack
    Properties:
      Location: onboarding/template.yaml
  
  ProjectOrganizationFeature:
    Type: AWS::Serverless::Application
    DependsOn:
      - DynamoDBStack
    Properties:
      Location: project-organization/template.yaml

  ApiGatewayFeature:
    Type: AWS::Serverless::Application
    DependsOn:
      - FeedbackFeature
    Properties:
      Location: API/template.yaml

  BrandSetupFeature:
    Type: AWS::Serverless::Application
    DependsOn:
      - S3Stack
    Properties:
      Location: brand-setup/template.yaml
      Parameters:
        S3BucketName: !ImportValue CAMMI-CammiBucketName


Outputs:
  DynamoDBStackOutput:
    Description: Outputs from nested DynamoDB stack
    Value: !Ref DynamoDBStack

  GoogleLibrariesLayerStackOutput:
    Description: Outputs from Google libraries layer stack
    Value: !Ref GoogleLibrariesLayerStack

  S3StackOutput:
    Description: Outputs from Cammi S3 stack
    Value: !Ref S3Stack

  FeedbackFeatureOutput:
    Description: Outputs from Feedback feature stack
    Value: !Ref FeedbackFeature

  AuthFeatureOutput:
    Description: Outputs from Auth feature stack
    Value: !Ref AuthFeature

  onboardingFeatureOutput:
    Description: Outputs from onboarding feature stack
    Value: !Ref OnboardingFeature
  
  ProjectOrganizationFeatureOutput:
    Description: Outputs from project-organization feature stack
    Value: !Ref ProjectOrganizationFeature